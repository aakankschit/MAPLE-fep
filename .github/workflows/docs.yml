name: Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'src/maple/**'
      - 'pyproject.toml'
      - 'requirements.txt'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'src/maple/**'
      - 'pyproject.toml'
      - 'requirements.txt'
      - '.github/workflows/docs.yml'
  workflow_dispatch:  # Allow manual triggering

# Grant GITHUB_TOKEN the permissions required to make a Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-docs-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-docs-
          ${{ runner.os }}-pip-
          
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y graphviz graphviz-dev pandoc
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .[docs,notebook]
        pip install marimo

    - name: Verify documentation dependencies
      run: |
        python -c "import sphinx; print(f'Sphinx version: {sphinx.__version__}')"
        python -c "import myst_parser; print('MyST parser available')"
        python -c "import sphinx_rtd_theme; print('RTD theme available')"
        python -c "import marimo; print(f'Marimo version: {marimo.__version__}')"

    - name: Export Marimo tutorials to HTML
      run: |
        export KMP_DUPLICATE_LIB_OK=TRUE
        for notebook in docs/tutorials/*.py; do
          if [ -f "$notebook" ]; then
            output_file="${notebook%.py}.html"
            echo "Exporting $notebook to $output_file"
            marimo export html "$notebook" -o "$output_file" --include-code || true
          fi
        done

    - name: Build documentation
      run: |
        export KMP_DUPLICATE_LIB_OK=TRUE
        cd docs
        make clean
        make html

    - name: Copy Marimo tutorials to build
      run: |
        mkdir -p docs/_build/html/tutorials
        cp docs/tutorials/*.html docs/_build/html/tutorials/ 2>/dev/null || true
        
    - name: Check documentation build
      run: |
        if [ ! -f "docs/_build/html/index.html" ]; then
          echo "ERROR: Documentation build failed - index.html not found"
          exit 1
        fi
        echo "✅ Documentation built successfully"
        
    - name: Upload documentation artifacts (for PR review)
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: documentation-html
        path: docs/_build/html/
        retention-days: 30

  deploy-docs:
    name: Deploy Sphinx Documentation to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    # Deploy to the github-pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .[docs,notebook]
        pip install marimo

    - name: Export Marimo tutorials to HTML
      run: |
        export KMP_DUPLICATE_LIB_OK=TRUE
        for notebook in docs/tutorials/*.py; do
          if [ -f "$notebook" ]; then
            output_file="${notebook%.py}.html"
            echo "Exporting $notebook to $output_file"
            marimo export html "$notebook" -o "$output_file" --include-code || true
          fi
        done

    - name: Build Sphinx documentation
      run: |
        export KMP_DUPLICATE_LIB_OK=TRUE
        cd docs
        make clean
        make html

    - name: Copy Marimo tutorials and add .nojekyll
      run: |
        mkdir -p docs/_build/html/tutorials
        cp docs/tutorials/*.html docs/_build/html/tutorials/ 2>/dev/null || true
        touch docs/_build/html/.nojekyll
        
    - name: Setup Pages
      uses: actions/configure-pages@v5
      
    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/_build/html
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  docs-link-check:
    name: Documentation Link Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .[docs]
        pip install sphinx-lint
        
    - name: Build documentation
      run: |
        export KMP_DUPLICATE_LIB_OK=TRUE
        cd docs
        make html
        
    - name: Lint documentation
      run: |
        sphinx-lint docs/
        
    - name: Check for documentation warnings
      run: |
        cd docs
        make html 2>&1 | tee build.log
        if grep -q "WARNING\|ERROR" build.log; then
          echo "⚠️ Documentation has warnings or errors:"
          grep "WARNING\|ERROR" build.log
          exit 1
        fi
        echo "✅ Documentation builds without warnings"
